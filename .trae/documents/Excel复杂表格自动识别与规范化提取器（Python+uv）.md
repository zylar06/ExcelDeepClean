# Excel 复杂表格自动提取与规范化程序计划

## 1. 核心目标
实现一个 Python 程序，能够从结构复杂的 Excel 文件中（包含合并单元格、多表混排、空行干扰）自动识别并提取出符合“数据库写入标准”的独立表格数据，输出为 JSON 或 CSV。

## 2. 核心定义
- **输入**：`.xlsx` 文件（支持 10万行+，复杂排版）。
- **输出**：
  - **数据文件**：`JSON`（对象列表）或 `CSV`（纯行列）。
  - **元数据**：包含 `table_id`、来源 Sheet、单元格范围、行列推断置信度等。
- **数据库写入标准**：
  - 必须有明确的列头（Header）。
  - 每一行的数据结构一致。
  - 单元格值原子化（无合并单元格，已拆分填充）。

## 3. 技术方案与架构
- **包管理**：使用 `uv` 管理依赖与虚拟环境。
- **Excel 处理**：使用 `openpyxl` 的 `read_only=True` 模式配合 XML 解析，实现低内存流式读取。
- **算法设计**：
  1.  **合并单元格预处理**：直接解析 `worksheet.xml` 提取 `<mergeCell>` 标签，构建“坐标->值”的映射索引，避免加载整个 Workbook 对象。
  2.  **智能边界检测**：
      - **栅格化**：将 Sheet 抽象为 0/1 矩阵（非空/空）。
      - **连通域分析**：识别独立的非空像素块（Connected Components）。
      - **投影切分**：对大块区域计算水平/垂直投影，识别内部的“空行分隔带”或“显著标题行”，将视觉上粘连但逻辑独立的表格切开。
  3.  **表格标准化**：
      - **表头识别**：在区域顶部扫描，基于“字符串占比”、“非空率”和“唯一性”评分，选定 Header 行。
      - **值填充**：依据合并单元格索引，将合并区域的值（通常在左上角）广播到区域内所有单元格（Forward Fill），确保数据库读取时每行数据完整。
- **工程结构**：
  ```text
  src/
    ├── config/       # 配置定义（阈值、规则）
    ├── core/         # 核心算法（读取、检测、提取）
    ├── utils/        # 工具函数
    ├── cli.py        # 命令行入口
    └── main.py       # 程序入口
  tests/              # pytest 测试用例
  ```

## 4. 实施步骤
1.  **环境初始化**：
    - 创建项目，配置 `pyproject.toml` (uv)。
    - 安装 `openpyxl`, `pytest` 等依赖。
2.  **核心模块开发**：
    - **Step 1**: 实现 `StreamReader`，支持流式读取并处理合并单元格映射。
    - **Step 2**: 实现 `TableDetector`，开发边界识别与切分算法。
    - **Step 3**: 实现 `TableExtractor`，负责表头推断、数据清洗与结构化。
3.  **集成与测试**：
    - 针对 `test_data.xlsx` 编写测试用例。
    - 验证内存占用（<500MB）与大文件性能。
    - 实现 JSON/CSV 输出模块。
4.  **文档与交付**：
    - 编写 `README.md`（安装、运行、配置说明）。
    - 编写 `docs/design.md`（算法原理）。
    - 最终代码审查与清理。

## 5. 验证标准
- 能够正确识别 `test_data.xlsx` 中的所有独立表格。
- 输出的 JSON/CSV 可以直接被解析并模拟插入数据库。
- 只有符合规则（如 >=2行2列）的表格被输出。
- 内存和速度满足要求。