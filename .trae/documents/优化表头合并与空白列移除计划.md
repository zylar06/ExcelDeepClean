# 优化 Excel 表头处理与空白列过滤计划

## 1. 问题分析
用户指出了两个关键问题：
1.  **合并单元格表头的语义冲突**：
    - 现象：“排序”和“显示位置”在视觉上都是跨两列的合并单元格。
    - 区别：“显示位置”下方的两列确实有不同的业务含义（例如“显示在详情页” vs “显示在编辑页”，即两个打钩的位置），因此需要保留为两列。而“排序”下方的两列在内容上其实是重复的或者第二列是空的/冗余的，用户希望只保留一列。
    - 难点：程序目前只是简单地将合并单元格的值填充到所有子单元格，导致“排序”变成了两个“排序”列，无法区分它和“显示位置”这种真正需要两列的情况。
2.  **无效的 `Column_X` 占位符**：
    - 现象：提取出的 JSON/Excel 中包含了大量 `Column_7`, `Column_8` 这样的列，实际上原表中这些位置是空白的，没有数据。
    - 需求：如果没有数据，就直接丢弃这些列，而不是用占位符填充。

## 2. 解决方案

### 针对问题 1：智能表头合并（AI + 启发式）
这确实是一个语义理解问题，很难仅靠算法完美解决。我建议采用 **"AI 提示词优化 + 数据特征后处理"** 的组合策略。

-   **优化 AI 提示词 (`AIProcessor`)**：
    -   在发送给 AI 的摘要中，包含表头信息和前几行数据。
    -   增加 Prompt 指令：*"Analyze the columns. If a column name is duplicated (e.g., '排序', '排序_2') AND the data in the second column is empty or identical to the first, mark it as 'redundant'. However, if the data in both columns is distinct (e.g., checkmarks in different rows), keep both."*
    -   让 AI 返回一个 `merge_columns` 动作。

-   **后处理逻辑 (`AIProcessor._apply_actions`)**：
    -   如果 AI 标记某列为冗余，则在生成最终表格时，从 `columns` 和 `rows` 中移除该字段。

### 针对问题 2：空白列自动修剪（算法优化）
这是一个纯算法问题，可以在 `TableExtractor` 阶段解决。

-   **优化 `TableExtractor`**：
    -   在提取完数据块后，进行一次**纵向扫描**。
    -   对于每一列，检查是否**全为空**（Header 除外）。
    -   如果某一列在所有数据行中都是 `None` 或空字符串，则直接从结果中剔除该列，不再生成 `Column_X`。

## 3. 实施步骤

1.  **修改 `extractor.py`**：
    -   在 `_process_table_data` 中增加 `_prune_empty_columns` 逻辑。
    -   遍历所有提取出的行，统计每列的非空值数量。
    -   如果某列非空数为 0，且列名是自动生成的 `Column_X` 格式（或者是空的），则删除。

2.  **修改 `ai/processor.py`**：
    -   更新 `_generate_row_summaries`，使其包含更多列的特征（如“列A和列B是否总是互斥”）。
    -   更新 Prompt，专门增加一段关于“合并列判别”的说明。
    -   增加 `merge_columns` 的 Action 处理逻辑。

3.  **验证**：
    -   重新运行 `process-json`，检查“排序”列是否合并，“显示位置”列是否保留。
    -   检查 `Column_X` 是否消失。

## 4. 用户确认
- 这个方案不需要用户额外操作，只需更新代码。
- AI 的判断可能仍有极小概率出错，但配合“全空列检测”算法，能解决 90% 的问题。

请确认是否执行此优化计划？